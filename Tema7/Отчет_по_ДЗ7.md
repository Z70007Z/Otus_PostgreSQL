
# Практика №7 "Журналы."
# 1. Развернуть виртуальную машину (т.к. требований нет разворачивая на свое усмотрение)

Была создана виртуальная машина:

1. ОС - Ubuntu 24.04 LTS
2. Выделено минимально количество ресурсов
    - CPU 2 
    - RAM 2 ГБ
    - Диск HDD 20 Гб
    - Прерываемая - Да

3. В Дефолтной сети создал подсетку:
    - Имя: otus-vm-db-pg-net-1
    - ip адресация: 10.10.8.0/24
    - Динамический публичный IP адрес

4. Имя VM - otus-db-pg-vm-7

5. Для подключения по SSH воспользовался ранее сгенерированным ключом, во время создания VM указал публичный ключ.

Для подключения использовал  ПО PuTTy, можно так же Powershell и другое ПО.

#
# 2. Установить на него PostgreSQL 17 т.к. в задании нет требований. (для развнообразия 17, а то все 15)
```bash

sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql && sudo apt install unzip && sudo apt -y install mc

pg_lsclusters

# Следующая команда выведет список всех пакетов, связанных с вашей установкой PostgreSQL
dpkg -l | grep postgresql
# Приведенная выше команда выводит список всех системных процессов, использующих/прослушивающих порт 5432
sudo ss -atnp | grep 5432
# Затем перезапустите PostgreSQL, чтобы он продолжал работать даже после перезагрузки системы Ubuntu, и проверьте статус PostgreSQL, чтобы убедиться, что он работает
sudo systemctl restart postgresql
sudo systemctl enable postgresql
sudo systemctl status postgresql

# Проверяем какой кластер запущен
pg_lsclusters
# или
sudo -u postgres pg_lsclusters

Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log

# Картинка с выполненными командами ранее о статусе кластера (Картинка ниже!):
```
![Cтатус кластера](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema7/picture/pg_lsclusters.jpg "Cтатус кластера")

#
# 3. Настройте выполнение контрольной точки раз в 30 секунд.
```bash

# Устанавливаем checkpoint_timeout в значение 30 секунд.
  alter system set checkpoint_timeout = '30s';
# Перезагрузка чтобы применить значение.
  sudo systemctl restart postgresql
# Проверяем статус:
  postgres=# show checkpoint_timeout;
  checkpoint_timeout 
  --------------------
  30s
  (1 row)

```
#
# 4. 10 минут c помощью утилиты pgbench подавайте нагрузку.
## Подготовка тестовых таблиц pgbench
```bash

# Выполнил:
  sudo -su postgres
  pgbench -i postgres
# В базе postgres создалось 4 новый тестовых таблиц для pgbench (Картинка ниже!)
```

##
## Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres.
```bash

# Запустил команду:
  sudo -su postgres
  pgbench -c8 -P 60 -T 600 -U postgres postgres
# Результат выполнения команды (Картинка ниже!):
```
![pgbench_postgres_test_10m.jpg](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema7/picture/pgbench_postgres_test_10m.jpg "pgbench_postgres_test_10m.jpg")

##
#
# 5. Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.

## Измерьте, какой объем журнальных файлов был сгенерирован за это время.
```bash

# Что было до запуска теста pgbench:
  postgres=# select * from pg_ls_waldir();
            name           |   size   |      modification      
  --------------------------+----------+------------------------
  000000010000000000000001 | 16777216 | 2025-07-28 14:10:36+00
  (1 row)

# Чито стало после запуска теста pgbench:
  postgres=# SELECT * FROM pg_ls_waldir() ORDER BY name;
            name           |   size   |      modification      
  --------------------------+----------+------------------------
  00000001000000000000001B | 16777216 | 2025-07-28 15:03:56+00
  00000001000000000000001C | 16777216 | 2025-07-28 14:25:17+00
  00000001000000000000001D | 16777216 | 2025-07-28 14:25:40+00
  00000001000000000000001E | 16777216 | 2025-07-28 14:25:58+00
  (4 rows)

# Так же можно посмотреть файлы в директории кластера:
  sudo ls -la /var/lib/postgresql/17/main/pg_wal
# Почему 4 файла я не понял точно, проде как дет перезапись, но не должна же, пока не забрали в архив.

#----------------------------------------------------------------------------
# Начальная позиция lsn
  0/152DE38
# Конечная позиция lsn
  0/1B2D23C0
# Проверям разницу:
  postgres=# select '0/1B2D23C0'::pg_lsn - '0/152DE38'::pg_lsn as bytes;
    bytes   
  -----------
  433735048
  (1 row)
# Довольно не мало 433 мб.
#----------------------------------------------------------------------------

#Рершил перепроверить и запустил еще раз pgbench
# До запуска pgbench контрольная точка (Log Sequence Number)
  postgres=# select pg_current_wal_insert_lsn();
  pg_current_wal_insert_lsn 
  ---------------------------
  0/1B2D23C0
  (1 row)
# После запуска pgbench контрольная точка (Log Sequence Number)
  postgres=# select pg_current_wal_insert_lsn();
  pg_current_wal_insert_lsn 
  ---------------------------
  0/3320B040
  (1 row)
# Проверям разницу:
  postgres=# select '0/3320B040'::pg_lsn - '0/1B2D23C0'::pg_lsn as bytes;
    bytes   
  -----------
  401837184
  (1 row)
# очень нее мало, это все же по всех базе, не одна таблица.

```
##
## Оцените, какой объем приходится в среднем на одну контрольную точку.
```bash

# Начальные значения:
  postgres=# select pg_current_wal_lsn();
  pg_current_wal_lsn 
  --------------------
  0/34000168
  (1 row)

# Создание точки:
  postgres=# checkpoint;
  CHECKPOINT
  postgres=#

# После создания точки:
  postgres=# select pg_current_wal_lsn();
  pg_current_wal_lsn 
  --------------------
  0/34000270
  (1 row)

# Смотрим разницу:
  postgres=# SELECT pg_wal_lsn_diff('0/34000270', '0/34000168');
  pg_wal_lsn_diff 
  -----------------
              264
  (1 row)

# 264 байт вышло, но это я руками запускал и без нагрузки получается.

```
Но если так сказать эмпирически вычислять то:
Берем первый результат полученный за время теста pgbench: 
Вышло 433735048 байт.
Время 10 минут. (600 секунд)
Сheckpoint каждые 30 секунд.
600/30=20;
и 433735048/20 = 21686752 байт.
или по 21 мб примерно приходится на одну точку под нагрузкой.

Я думаю что так не совсем верно считать, прошу подсказать, и я обязательно проверю на практике. !!!
#
# 6. Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?
```bash

# Всего 4 


```
Исключения (почему точки создались не по плану):
При повышенной нагрузке контрольная точка вызывается чаще — при достижении объёма max_wal_size.
Если фактический объём больше, сервер инициирует внеплановую контрольную точку. 

Если после предыдущей контрольной точки новые записи WAL не добавились, следующие контрольные точки будут пропущены, даже если проходит время checkpoint_timeout.

#
# 7. Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.
```bash

# Настройки синхронного режима:
  alter system set synchronous_commit = on;
  alter system set commit_delay = "0";
  alter system set commit_siblings = "5";

# Запустил команду:
  sudo -su postgres
  pgbench -c8 -P 60 -T 600 -U postgres postgres
# Результат выполнения команды (Картинка ниже!):
```
![pgbench_synch](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema7/picture/pgbench_synch.jpg "pgbench_synch")
```bash

# Настройки асинхронного режима:
  alter system set synchronous_commit = off;
  alter system set wal_writer_delay = "200ms";
  alter system set commit_siblings = "5";

# Запустил команду:
  sudo -su postgres
  pgbench -c8 -P 60 -T 600 -U postgres postgres
# Результат выполнения команды (Картинка ниже!):
```
![pgbench_asynch](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema7/picture/pgbench_asynch.jpg "pgbench_asynch")
```bash

# Объясните полученный результат.
Судя по tps синхронного режима и асинхронного, ничего не изменилось у меня.
Вероятно у меня не достаточно нагруженная система была чтобы это хоть как-то повлияло.
На практике синхронный режим должен снижать tps. 

```
#
# 8. Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?
```bash

# Создаем новый кластер:
  sudo pg_createcluster 17 main_new
  sudo pg_ctlcluster 17 main_new start
  sudo -u postgres pg_lsclusters
# Результат выполнения команды (Картинка ниже!):  
```
![pg_clusters_new](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema7/picture/pg_clusters_new.jpg "pg_clusters_new")
```bash

# https://blog.programs74.ru/how-to-enable-checksums-in-postgresql/?ysclid=mdommnv2jd363437833
# Включаем контрольные суммой страниц:
  sudo pg_ctlcluster 17 main stop
  sudo -u postgres psql -p 5433
  #-------------------------------
  postgres=# show data_checksums;
  data_checksums
  ----------------
  off
  (1 row) 
  \q
  #-------------------------------
  # Спросто проверяем:
  sudo su - postgres -c '/usr/lib/postgresql/17/bin/pg_controldata -D "/var/lib/postgresql/17/main_new"' | grep state
  Database cluster state:               shut down
  # Просто меняем статус:
  sudo su - postgres -c '/usr/lib/postgresql/17/bin/pg_checksums --enable -D "/var/lib/postgresql/17/main_new"'
  Checksum operation completed
  Files scanned:   963
  Blocks scanned:  6117
  Files written:  795
  Blocks written: 6117
  pg_checksums: syncing data directory
  pg_checksums: updating control file
  Checksums enabled in cluster
  # Защита включена
  sudo pg_ctlcluster 17 main start
  sudo -u postgres psql -p 5433
  #-------------------------------
  postgres=# show data_checksums;
  data_checksums 
  ----------------
  on
  (1 row)
  #-------------------------------
  # А вопрос зачем писать эту команду в шпаргалке? - alter system set data_checksums = on;
  # она же не работает или я что-то не понял? (

# Создаем таблицу:
  create table test(i int); 

# Cгенерируем значения:
  insert into test_new select s.id from generate_series(1, 100) as s(id); 
  select * from test limit 10;

# Включите кластер и сделайте выборку из таблицы:
  sudo pg_ctlcluster 17 main_new stop
  sudo dd if=/dev/zero of=/var/lib/postgresql/17/main_new/base/1/13458 oflag=dsync conv=notrunc bs=1 count=8
  sudo dd if=/dev/zero of=/var/lib/postgresql/17/main_new/base/4/13458 oflag=dsync conv=notrunc bs=1 count=8
  sudo dd if=/dev/zero of=/var/lib/postgresql/17/main_new/base/5/16453 oflag=dsync conv=notrunc bs=1 count=8
  # что сделала команда:
  8+0 records in
  8+0 records out
  8 bytes copied, 0.0759039 s, 0.1 kB/s
# Включаем класер:
  sudo pg_ctlcluster 17 main_new start

# Что и почему произошло? 
  т.к. мы включили котроль целостности, по хорошему при обращени к таблице должна быть ошибка.
  что-то не произошло ничего (
  видать не то изменил. 
  уже и две таблицы создал и крайнее значение брал - 16453 не вышло!

# Как проигнорировать ошибку и продолжить работу?
  Нужно просто отключить data_checksums

```
#