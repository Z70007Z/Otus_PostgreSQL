
# Практика №6 "MVCC, vacuum и autovacuum."
# 1. Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB

Была создана виртуальная машина:

1. ОС - Ubuntu 24.04 LTS
2. Выделено минимально количество ресурсов
    - CPU 2 
    - RAM 4 ГБ
    - Диск SSD 10 Гб
    - Прерываемая - Да

3. В Дефолтной сети создал подсетку:
    - Имя: otus-vm-db-pg-net-1
    - ip адресация: 10.10.8.0/24
    - Динамический публичный IP адрес

4. Имя VM - otus-db-pg-vm-6

5. Для подключения по SSH воспользовался ранее сгенерированным ключом, во время создания VM указал публичный ключ.

Для подключения использовал  ПО PuTTy, можно так же Powershell и другое ПО.

#

# 2. Установить на него PostgreSQL 15 с дефолтными настройками
```bash

# https://www.ubuntumint.com/install-postgresql-in-ubuntu/

sudo apt update && sudo apt upgrade -y
# Сначала нужно импортировать ключ PostgreSQL GPG для проверки подлинности установочного пакета:
curl -fSsL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | sudo tee /usr/share/keyrings/postgresql.gpg > /dev/null
# Импортируем стабильный репозиторий PostgreSQL 15, который, как следует из названия, содержит последнюю безопасную, рабочую и стабильную версию
echo deb [arch=amd64,arm64,ppc64el signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main | sudo tee /etc/apt/sources.list.d/postgresql.list
# Теперь нужжно обновить список источников репозитория, чтобы он отражал новые дополнения. Для этого выполним следующую команду:
sudo apt update -y
# Установка PostgreSQL с помощью следующей команды
sudo apt install postgresql-client-15 postgresql-15 -y

# Следующая команда выведет список всех пакетов, связанных с вашей установкой PostgreSQL
dpkg -l | grep postgresql
# Приведенная выше команда выводит список всех системных процессов, использующих/прослушивающих порт 5432
sudo ss -atnp | grep 5432
# Затем перезапустите PostgreSQL, чтобы он продолжал работать даже после перезагрузки системы Ubuntu, и проверьте статус PostgreSQL, чтобы убедиться, что он работает
sudo systemctl restart postgresql
sudo systemctl enable postgresql
sudo systemctl status postgresql

# Проверяем какой кластер запущен
pg_lsclusters
# или
sudo -u postgres pg_lsclusters

Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log

# Картинка с выполненными командами ранее о статусе кластера (Картинка ниже!):
```
![Cтатус кластера](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema6/picture/pg_lsclusters.jpg "Cтатус кластера")

#

# 3. Создать БД для тестов: выполнить pgbench -i postgres
```bash

# Выполнли:
sudo su 
su postgres
pgbench -i postgres
# В базе postgres создалось 4 новый тестовых таблиц для pgbench (Картинка ниже!)
```
![New_table_pgbench](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema6/picture/New_table_pgbench.jpg "New_table_pgbench")


#
# 4. Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres
```bash

# Запустил команду:
pgbench -c8 -P 6 -T 60 -U postgres postgres
# Результат выполнения команды (Картинка ниже!):
```
![pgbench_postgres](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema6/picture/pgbench_postgres.jpg "pgbench_postgres")

#
# 5. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла


## О железе !!!
```bash

# Что рекомендовали:
# DB Version: 11
# OS Type: linux
# DB Type: dw
# Total Memory (RAM): 4 GB
# CPUs num: 1
# Data Storage: hdd
# Ну я на этом этапе переделывать мишу уже не буду, как-то странно
# Первым пунктом четко указало: Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB
# В тут несколько другое.
# Так что оставляю как есть изначально.

```
## Мысли о железе 
## О настройках! 
```bash

# Что рекомендовали:
max_connections = 40
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 512MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 500
random_page_cost = 4
effective_io_concurrency = 2
work_mem = 6553kB
min_wal_size = 4GB
max_wal_size = 16GB

# Как по умолчанию и станет:
| запрос                             | сейчас  | будет  |
| ---------------------------------- |:-------:| ------:|
| show max_connections;              | 100     | 40     |
| show shared_buffers;               | 128MB   | 1GB    |
| show effective_cache_size;         | 4GB     | 3GB    |
| show maintenance_work_mem;         | 64MB    | 512MB  |
| show checkpoint_completion_target; | 0.9     | 0.9    |
| show wal_buffers;                  | 4MB     | 16MB   |
| show default_statistics_target;    | 100     | 500    |
| show random_page_cost;             | 4       | 4      |
| show effective_io_concurrency;     | 1       | 2      | 
| show work_mem;                     | 4MB     | 6553kB |
| show min_wal_size;                 | 80MB    | 4GB    |
| show max_wal_size;                 | 1GB     | 16GB   |

```
![pgbench_postgres](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema6/picture/pgbench_postgres.jpg "pgbench_postgres")

#

