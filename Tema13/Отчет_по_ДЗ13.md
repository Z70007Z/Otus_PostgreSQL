
# Практика №13 "Резервное копирование и восстановление "
# 1. Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и HDD 20GB.

Была создана виртуальная машина:

1. ОС - Ubuntu 24.04 LTS
2. Выделено минимально количество ресурсов
    - CPU 2 
    - RAM 4 ГБ
    - Диск HDD 20 Гб
    - Прерываемая - Да

3. В Дефолтной сети создал подсетку:
    - Имя: otus-vm-db-pg-net-1
    - ip адресация: 10.10.8.0/24
    - Динамический публичный IP адрес

4. Имя VM - otus-db-pg-vm-13

5. Для подключения по SSH воспользовался ранее сгенерированным ключом, во время создания VM указал публичный ключ.

Для подключения использовал  ПО PuTTy, можно так же Powershell и другое ПО.

#

# 2. Установить на него PostgreSQL 15 с дефолтными настройками.
```bash

# https://www.ubuntumint.com/install-postgresql-in-ubuntu/

sudo apt update && sudo apt upgrade -y
# Сначала нужно импортировать ключ PostgreSQL GPG для проверки подлинности установочного пакета:
curl -fSsL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | sudo tee /usr/share/keyrings/postgresql.gpg > /dev/null
# Импортируем стабильный репозиторий PostgreSQL 15, который, как следует из названия, содержит последнюю безопасную, рабочую и стабильную версию
echo deb [arch=amd64,arm64,ppc64el signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main | sudo tee /etc/apt/sources.list.d/postgresql.list
# Теперь нужжно обновить список источников репозитория, чтобы он отражал новые дополнения. Для этого выполним следующую команду:
sudo apt update -y
# Установка PostgreSQL с помощью следующей команды
sudo apt install postgresql-client-15 postgresql-15 -y

# Следующая команда выведет список всех пакетов, связанных с вашей установкой PostgreSQL
dpkg -l | grep postgresql
# Приведенная выше команда выводит список всех системных процессов, использующих/прослушивающих порт 5432
sudo ss -atnp | grep 5432
# Затем перезапустите PostgreSQL, чтобы он продолжал работать даже после перезагрузки системы Ubuntu, и проверьте статус PostgreSQL, чтобы убедиться, что он работает
sudo systemctl restart postgresql
sudo systemctl enable postgresql
sudo systemctl status postgresql

# Проверяем какой кластер запущен
pg_lsclusters
# или
sudo -u postgres pg_lsclusters

Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log

# Картинка с выполненными командами ранее о статусе кластера (Картинка ниже!):
```
![Статус кластера](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema13/picture/status_cluster.jpg "Статус кластера")

#
# Создаем БД, схему и в ней таблицу.
```bash

# Входим в psql:
sudo -u postgres psql

# Создаю базу:
postgres=# create database otus;
CREATE DATABASE

# Создаю схему:
postgres=# create schema otus_schema;
CREATE SCHEMA

# Устанавливаю путь поиска схем для текущей сессии:
postgres=# SET search_path = otus_schema, publ;
SET
# или лучше:
ALTER ROLE postgres IN DATABASE otus SET search_path TO otus_schema,public;
# Установим схему otus_schema для роли postgres в базе otus, как схему по умолчанию на постоянную.

# Подключаюсь к базе
\c otus;

# Создаем табличку:
postgres=# CREATE TABLE otus_schema.otus_table (
  id serial,
  fio char(100)
);
CREATE TABLE

```
#
# Заполним таблицы автосгенерированными 100 записями.
```bash

# Заполняем таблицу otus_table записями:
INSERT INTO otus_table(fio) SELECT 'noname' FROM generate_series(1,100);

# Проверяю успешность заполнения таблицы: 
otus=# SELECT count(*) FROM otus_table;
 count 
-------
   100
(1 row)

```
#
# Под линукс пользователем Postgres создадим каталог для бэкапов.
```bash

# Создаем папку:
sudo mkdir /backup

# Выдаем права для пользователя postgres:
sudo chown -R postgres:postgres /backup

```
#
# Сделаем логический бэкап используя утилиту COPY.
```bash

# Выполняем команду для создания логического бэкапа:
\COPY otus_table TO '/backup/otus_table.sql';
COPY 100
# или
\COPY otus_schema.otus_table TO '/backup/otus_table1.sql';
COPY 100

# Смотрим наличие файлов:
admin_s@otus-db-pg-vm-13:~$ ls -la /backup/
total 32
drwxr-xr-x  2 postgres postgres  4096 Sep 28 12:40 .
drwxr-xr-x 22 root     root      4096 Sep 28 12:15 ..
-rw-rw-r--  1 postgres postgres 10392 Sep 28 12:38 otus_table.sql
-rw-rw-r--  1 postgres postgres 10392 Sep 28 12:39 otus_table1.sql

# Смотрим что файлы не пустые:
admin_s@otus-db-pg-vm-13:~$ sudo cat /backup/otus_table.sql
1       noname
2       noname
3       noname
4       noname
5       noname
6       noname
7       noname
8       noname
...

```
#
# Восстановим в 2 таблицу данные из бэкапа.
```bash

# Создаем новую пустую табличку:
CREATE TABLE otus_schema.otus_table_new (
  id serial,
  fio char(100)
);

# И восстанавливаем данные из копии в пустую базу:
\COPY otus_schema.otus_table_new FROM '/backup/otus_table.sql';

# Проверим что записи появились:
SELECT count(*) FROM otus_table_new;
 count 
-------
   100
(1 row)

```
#
# Используя утилиту pg_dump создадим бэкап в кастомном сжатом формате двух таблиц.
```bash

# Входим в psql:
sudo -u postgres psql

# Смотрим что будем копировать:
otus=# \dt
                List of relations
   Schema    |      Name      | Type  |  Owner
-------------+----------------+-------+----------
 otus_schema | otus_table     | table | postgres
 otus_schema | otus_table_new | table | postgres
(2 rows)

# Выходим:
exit

# Переходим под пользователя postgres:
sudo su
su - postgres

# И запускаем создание 
pg_dump -d otus -C -U postgres -p 5432 > /backup/otus_arh.sql
pg_dump -d otus --create -U postgres -Fc -p 5432 > /backup/otus_arh.gz

# Смотрим наличие файлов:
postgres@otus-db-pg-vm-13:~$ ls -la /backup/
total 40
drwxr-xr-x  2 postgres postgres  4096 Sep 28 13:17 .
drwxr-xr-x 22 root     root      4096 Sep 28 12:15 ..
-rw-rw-r--  1 postgres postgres  4985 Sep 28 13:17 otus_arh.gz
-rw-rw-r--  1 postgres postgres 10392 Sep 28 12:38 otus_table.sql
-rw-rw-r--  1 postgres postgres 10392 Sep 28 12:39 otus_table1.sql

```
## Используя утилиту pg_restore восстановим в новую БД только вторую таблицу!
```bash

# Переходим под пользователя postgres:
sudo su
su - postgres

# Выходим в консоль psql:
postgres@otus-db-pg-vm-13:~$ psql

# Удаляю таблиту:
otus=# drop table otus_table_new;
DROP TABLE

# Проверяю что осталось:
otus=# \dt
              List of relations
   Schema    |    Name    | Type  |  Owner
-------------+------------+-------+----------
 otus_schema | otus_table | table | postgres
(1 row)

# Выходим:
otus=# exit

# Запускаю восстановление:
pg_restore -t otus_table_new -d otus -U postgres -p 5432 /backup/otus_arh.gz

# Смотрим результат:
otus=# \dt
                List of relations
   Schema    |      Name      | Type  |  Owner
-------------+----------------+-------+----------
 otus_schema | otus_table     | table | postgres
 otus_schema | otus_table_new | table | postgres
(2 rows)

# Выполнил успешное восстановление выбранной таблицы.

```
#