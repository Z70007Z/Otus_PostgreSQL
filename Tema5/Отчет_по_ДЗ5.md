

# 1. Развернуть виртуальную машину любым удобным способом

Была создана виртуальная машина:

1. ОС - Ubuntu 24.04 LTS
2. Выделено минимально количество ресурсов
    - CPU 2 
    - RAM 2 ГБ
    - Диск HDD 20 Гб
    - Прерываемая - Да

3. В Дефолтной сети создал подсетку:
    - Имя: otus-vm-db-pg-net-1
    - ip адресация: 10.10.8.0/24
    - Динамический публичный IP адрес

4. Имя VM - otus-db-pg-vm-5

5. Для подключения по SSH воспользовался ранее сгенерированным ключом, во время создания VM указал публичный ключ.

Для подключения использовал  ПО PuTTy, можно так же Powershell и другое ПО.

#

# 2. Поставить на неё PostgreSQL 15 любым способом.
```bash

# https://www.ubuntumint.com/install-postgresql-in-ubuntu/

sudo apt update && sudo apt upgrade -y
# Сначала нужно импортировать ключ PostgreSQL GPG для проверки подлинности установочного пакета:
curl -fSsL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | sudo tee /usr/share/keyrings/postgresql.gpg > /dev/null
# Импортируем стабильный репозиторий PostgreSQL 15, который, как следует из названия, содержит последнюю безопасную, рабочую и стабильную версию
echo deb [arch=amd64,arm64,ppc64el signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main | sudo tee /etc/apt/sources.list.d/postgresql.list
# Теперь нужжно обновить список источников репозитория, чтобы он отражал новые дополнения. Для этого выполним следующую команду:
sudo apt update
# Установка PostgreSQL с помощью следующей команды
sudo apt install postgresql-client-15 postgresql-15

# Следующая команда выведет список всех пакетов, связанных с вашей установкой PostgreSQL
dpkg -l | grep postgresql
# Приведенная выше команда выводит список всех системных процессов, использующих/прослушивающих порт 5432
sudo ss -atnp | grep 5432
# Затем перезапустите PostgreSQL, чтобы он продолжал работать даже после перезагрузки системы Ubuntu, и проверьте статус PostgreSQL, чтобы убедиться, что он работает
sudo systemctl restart postgresql
sudo systemctl enable postgresql
sudo systemctl status postgresql

# Проверяем какой кластер запущен
pg_lsclusters

Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log

# Осваиваем Markdown далее, для интереса картинка с выполненными командами ранее о статусе кластера (картинка ниже!):
```
![Cтатус кластера](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/check_work_cluster.gif "Cтатус кластера")
![Cтатус кластера](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/check_work_cluster.jpg "Cтатус кластера")

#

# 3. Настроить кластер PostgreSQL 15 на максимальную производительность не обращая внимание на возможные проблемы с надежностью в случае аварийной перезагрузки виртуальной машины

## Сервер.
```bash

# Прошлось доавить процессоров до 4 и RAM до 4
# Диск правада HDD

```
##
## Настройки подключения postgres.
```bash


# Смотрим где конфиг файлы:
sudo -u postgres psql -c "SHOW config_file;"
could not change directory to "/home/admin_s": Permission denied
               config_file
-----------------------------------------
 /etc/postgresql/15/main/postgresql.conf
(1 row)

# Скачать Dbeaver, хочу подключиться для удобства. (а для этого нужно открыть прослушивание ip)
sudo nano /etc/postgresql/15/main/postgresql.conf
# Открываю для всех, т.к. у меня не белый адрес:
listen_addresses = '*'         # what IP address(es) to listen on;
# И перечитываем конфиг
sudo systemctl restart postgresql
# И да порт стал доступен (картинка ниже!):
```
![Проверка доступности порта](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/test_port.jpg "Проверка доступности порта")
```bash

# Настраиваем разрешение на подключение к базам:
sudo nano /etc/postgresql/15/main/pg_hba.conf
# Ко всем базам с любых ip: 
# host all all 0.0.0.0/0 md5
# И перечитываем конфиг
sudo systemctl restart postgresql
# И да результат не заставил себя ждать (картинка ниже!):
```
![Успешное подключение!](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/Connect_to_postgres.jpg "Успешное подключение")

##
## Подготовка и тестирвоание до настройки
```bash

# Dbeaver - как же тупо запрограммировано упрааление окнами в этом приложении ((

# Слздал базу для тестирования 
CREATE DATABASE test_db;
# Создаем таблицы для тестирования.
pgbench -i -s 10 test_db

# Результат выполнения команды:
admin_s@otus-db-pg-vm-5:~$ sudo su
root@otus-db-pg-vm-5:/home/admin_s# su postgres
postgres@otus-db-pg-vm-5:/home/admin_s$ pgbench -i -s 10 test_db
dropping old tables...
NOTICE:  table "pgbench_accounts" does not exist, skipping
NOTICE:  table "pgbench_branches" does not exist, skipping
NOTICE:  table "pgbench_history" does not exist, skipping
NOTICE:  table "pgbench_tellers" does not exist, skipping
creating tables...
generating data (client-side)...
1000000 of 1000000 tuples (100%) done (elapsed 2.31 s, remaining 0.00 s)
vacuuming...
creating primary keys...
done in 3.54 s (drop tables 0.00 s, create tables 0.02 s, client-side generate 2.62 s, vacuum 0.10 s, primary keys 0.79 s).

# И запустить тестирвоание на основе созданных таличек
pgbench -c 10 -j 2 -t 5000 test_db 
# -c - число клиентов
# -j - чисто потоков
# -t - чисто транзакций
# и далее имя базы 

# Запускаем (картинка ниже!):
```
![pgbench Тест 1](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/test_pgbench_1.jpg "pgbench Тест 1")
```bash
# Ну такое себе откровенное барахло наш так сказать сервер! 

# Проверка загруженности сети
tc -s -d qdisc ls dev eth0
# Все ок

# Можно проверить распараллеливание и наличия других нестандартных параметров
explain (analyze, settings)
select * from pgbench_accounts

# Воспользовался pgtune с сайта - https://pgtune.fariton.ru/
# При вводе параметров из лекции показал теже выходжные данные. 
# Вот что показали расчеты этого приложения (картинка ниже!):
```
![ppgtune](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/pgtune.jpg "ppgtune")
```bash

# Смотрим нагруженность системы в тихом режиме так сказать (картинка ниже!):
admin_s@otus-db-pg-vm-5:~$ top 
```
![top](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/top.jpg "top")
```bash

# Смотрим нагруженность системы в тесте при базовых настройках (картинка ниже!):
pgbench -c 10 -j 2 -t 5000 test_db
top
```
![pgbench_top](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/pgbench_top.jpg "pgbench_top")
```bash
# Все в пределх нормы.


```
##
## Непосредственные настройки для задания центрального процессора
```bash

# Подсистемы центрального процессора.

# Общее число фоновых процессов
show max_worker_processes;
# По умолчинию равен = 8 

# Минимальное ограничение количества рабочих процессов на распараллеливание исполнения запроса задает параметр
show max_parallel_workers_per_gather;
# По умолчинию равен = 2

# Указывающим сколько всего может быть параллельных потоков
show max_parallel_workers;
# По умолчинию равен = 8

# Задаёт максимальное число рабочих процессов, которые могут запускаться одной служебной командой
show max_parallel_maintenance_workers;
# По умолчинию равен = 2

# Делаю странное:
# Сильно завысиил относительно рекомендуемых, но кратно и попарно ) 
# В /etc/postgresql/15/main/postgresql.conf изменить параметры можно
sudo nano /etc/postgresql/15/main/postgresql.conf
max_worker_processes = 16
# (change requires restart)
max_parallel_workers_per_gather = 8
# limited by max_parallel_workers
max_parallel_maintenance_workers = 8
# limited by max_parallel_workers
max_parallel_workers = 16
# number of max_worker_processes that

# ИЛИ
# Рекосендовали извенять postgresql.auto.conf 
# /var/lib/postgresql/15/main/postgresql.auto.conf 
ALTER SYSTEM set max_worker_processes = 16;
ALTER SYSTEM set max_parallel_workers_per_gather = 8;
ALTER SYSTEM set max_parallel_workers = 16;
ALTER SYSTEM set max_parallel_maintenance_workers = 8;
sudo systemctl restart postgresql

```
##
## Непосредственные настройки для задания памяти
```bash

# Смотрим процессы postrges
sudo ps auxf | grep postgres
# Вывод команды (картинка ниже!):
```
![Процессы postgres](https://github.com/Z70007Z/Otus_PostgreSQL/blob/main/Tema5/picture/ps_postgres.jpg "Процессы postgres")
```bash


```
##

#
